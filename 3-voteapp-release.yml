parameters:
- name: dockerTag
  displayName: Docker Tag (Required)
  type: string

trigger:
- none

pr:
- none

variables:
- group: kv-core-210713               # The name of the ado keyvault variable group.
- name:  objSuffix
  value: voteapp-220606-1000

- name:  rgNamePrd
  value: 'rg-prd-$(objSuffix)'
- name:  aksNamePrd
  value: 'aks-prd-nteu-$(objSuffix)'
- name:  mySqlFqdnPrd
  value: 'mysql-prd-nteu-$(objSuffix).mysql.database.azure.com'
- name:  mySqlName
  value: 'mysql-prd-nteu-$(objSuffix)'

jobs:

# Deploy voting app manifests to prd.
- job: 'k8sDeployPrd'
  displayName: 'K8s - Deploy (PRD)'
  condition: eq(variables['Build.SourceBranchName'], 'prd')
  pool:
    vmImage: 'ubuntu-18.04'
  steps:

  - bash: |
      sed -i.bak 's#apple#${{ parameters.dockerTag }}#' ./*.yaml
      sed -i.bak 's#grape#$(mySqlFqdnPrd)#' ./*.yaml
      sed -i.bak 's#lemon#$(mySqlName)#' ./*.yaml
      sed -i.bak 's#melon#prd.rhod3rz.com#' ./*.yaml
      cat analytics.yaml
      cat voting.yaml
    displayName: 'K8s - Update Manifests (PRD)'
    workingDirectory: 'k8s/'

  # - bash: |
  #     az login --service-principal -u $(KV-ARM-CLIENT-ID) -p $(KV-ARM-CLIENT-SECRET) --tenant $(KV-ARM-TENANT-ID)
  #     az aks get-credentials --resource-group $(rgNamePrd) --name $(aksNamePrd) --admin
  #   displayName: 'K8s - Deploy (PRD)'
  #   workingDirectory: 'k8s/'
