steps:

- bash: |
    sed -i.bak 's#apple#${{ parameters.tag }}#' ./*.yaml
    sed -i.bak 's#grape#${{ parameters.mySqlFqdn }}#' ./*.yaml
    sed -i.bak 's#lemon#{{ parameters.mySqlName }}#' ./*.yaml
    sed -i.bak 's#melon#{{ parameters.url }}#' ./*.yaml
    cat analytics.yaml
    cat voting.yaml
  displayName: 'K8s - Update Manifests (PRD)'
  workingDirectory: 'k8s/'

# - bash: |
#     az login --service-principal -u $(KV-ARM-CLIENT-ID) -p $(KV-ARM-CLIENT-SECRET) --tenant $(KV-ARM-TENANT-ID)
#     az aks get-credentials --resource-group $(rgNamePrd) --name $(aksNamePrd) --admin
#     kubectl apply -f ./analytics.yaml
#     kubectl apply -f ./voting.yaml
#   displayName: 'K8s - Deploy (PRD)'
#   workingDirectory: 'k8s/'


# If branch is 'prd', swap 'prd' out to 'stg' for easy rollback.
- task: AzureAppServiceManage@0
  condition: eq(variables['Build.SourceBranchName'], 'prd')
  displayName: 'Backup prd to stg slot'
  inputs:
    azureSubscription: ${{ parameters.azureSub }}
    Action:            'Swap Slots'
    WebAppName:        ${{ parameters.webAppName }}
    ResourceGroupName: ${{ parameters.rgName }}
    SourceSlot:        'stg'

